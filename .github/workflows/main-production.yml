name: Main Branch Production Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'bike-shop/**'
      - '!bike-shop/node_modules/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show commit info
      run: |
        echo "COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
        echo "Building and deploying commit: $COMMIT_SHA"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: bike-shop/package-lock.json

    - name: Install dependencies
      run: |
        cd bike-shop
        npm ci

    - name: Build application
      run: |
        cd bike-shop
        npm run build

    - name: Build Docker image
      run: |
        docker build --no-cache -t bike-shop-test ./bike-shop

    - name: Save Docker image
      run: |
        docker save bike-shop-test:latest -o ./docker-images/bike-shop-test-${COMMIT_SHA}.tar

    - name: Deploy to production server
      run: |
        scp ./docker-images/bike-shop-test-${COMMIT_SHA}.tar app@192.168.1.47:~/aplikacja_biker/
        scp -r ./bike-shop/nginx.conf app@192.168.1.47:~/aplikacja_biker/

    - name: Run production container
      run: |
        ssh app@192.168.1.47 "
          docker load -i ~/aplikacja_biker/bike-shop-test-${COMMIT_SHA}.tar
          docker stop bike-shop-container 2>/dev/null || true
          docker rm bike-shop-container 2>/dev/null || true
          docker run -d \
            --name bike-shop-container \
            -p 8080:80 \
            bike-shop-test:latest
        "

    - name: Verify production deployment
      run: |
        ssh app@192.168.1.47 "
          echo '=== Docker containers ==='
          docker ps | grep bike-shop-container
          echo '=== Production app ready at http://192.168.1.47:8080 ==='
        "