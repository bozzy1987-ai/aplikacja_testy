name: Build and Test Application

on:
  push:
    branches: [ runner_test ]
  pull_request:
    branches: [ runner_test ]

jobs:
  build:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: bike-shop/package-lock.json
        
    - name: Install dependencies
      run: |
        cd bike-shop
        npm ci
        
    - name: Run linting
      run: |
        cd bike-shop
        npm run lint || echo "Linting skipped - no script found"
        
    - name: Build application
      run: |
        cd bike-shop
        npm run build
        
    - name: Check build artifacts
      run: |
        cd bike-shop
        ls -la dist/
        
    - name: Build Docker image
      run: |
        docker build -t bike-shop-test ./bike-shop
        
    - name: Test Docker image
      run: |
        docker images | grep bike-shop-test
        
    - name: Save Docker image
      run: |
        mkdir -p /home/actions-runner/docker-images
        VERSION=$(date +%Y%m%d-%H%M%S)
        docker save bike-shop-test -o /home/actions-runner/docker-images/bike-shop-test-${VERSION}.tar
        echo "Docker image saved to /home/actions-runner/docker-images/bike-shop-test-${VERSION}.tar"
        ls -lh /home/actions-runner/docker-images/