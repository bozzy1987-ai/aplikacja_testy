name: Build and Deploy Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - production
        - staging
  workflow_call:

jobs:
  build:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: bike-shop/package-lock.json
        
    - name: Install dependencies
      run: |
        cd bike-shop
        npm ci
        
    - name: Run linting
      run: |
        cd bike-shop
        npm run lint || echo "Linting skipped - no script found"
        
    - name: Build application
      run: |
        cd bike-shop
        npm run build
        
    - name: Check build artifacts
      run: |
        cd bike-shop
        ls -la dist/
        
    - name: Build Docker image
      run: |
        docker build -t bike-shop-test ./bike-shop
        
    - name: Save Docker image
      run: |
        VERSION=$(date +%Y%m%d-%H%M%S)
        mkdir -p ./docker-images
        docker save bike-shop-test:latest -o ./docker-images/bike-shop-test-${VERSION}.tar
        echo "Docker image saved to: ./docker-images/bike-shop-test-${VERSION}.tar"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: ./docker-images/*.tar
        retention-days: 1

  deploy-staging:
    runs-on: self-hosted
    needs: build
    if: success() && (github.event.inputs.environment == 'staging' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        
    - name: Transfer image to staging server
      run: |
        IMAGE_FILE=$(ls -t *.tar | head -1)
        scp $IMAGE_FILE stage1@192.168.1.59:~/aplikacja_biker/
        scp -r ./bike-shop/nginx.conf stage1@192.168.1.59:~/aplikacja_biker/
        
    - name: Deploy to staging server
      run: |
        IMAGE_FILE=$(ls -t *.tar | head -1)
        ssh stage1@192.168.1.59 "
          # Create directory if not exists
          mkdir -p ~/aplikacja_biker
          
          # Load Docker image with proper file path
          docker load -i ~/aplikacja_biker/${IMAGE_FILE}
          
          # Stop and remove old container
          docker stop bike-shop-container 2>/dev/null || true
          docker rm bike-shop-container 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name bike-shop-container \
            -p 8080:80 \
            bike-shop-test:latest
        "
        
    - name: Verify staging deployment
      run: |
        ssh stage1@192.168.1.59 "
          echo '=== Docker containers ==='
          docker ps | grep bike-shop-container
          
          echo '=== Staging app ready at http://192.168.1.59:8080 ==='
          curl -I http://localhost:8080 || echo 'Application not accessible yet'
        "

  deploy-production-ready:
    runs-on: self-hosted
    needs: build
    if: success() && github.event.inputs.environment == 'production'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        
    - name: Transfer image to staging server
      run: |
        IMAGE_FILE=$(ls -t *.tar | head -1)
        scp $IMAGE_FILE stage1@192.168.1.59:~/aplikacja_biker/
        scp -r ./bike-shop/nginx.conf stage1@192.168.1.59:~/aplikacja_biker/
        
    - name: Deploy to staging server
      run: |
        IMAGE_FILE=$(ls -t *.tar | head -1)
        ssh stage1@192.168.1.59 "
          # Create directory if not exists
          mkdir -p ~/aplikacja_biker
          
          # Load Docker image with proper file path
          docker load -i ~/aplikacja_biker/${IMAGE_FILE}
          
          # Stop and remove old container
          docker stop bike-shop-container 2>/dev/null || true
          docker rm bike-shop-container 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name bike-shop-container \
            -p 8080:80 \
            bike-shop-test:latest
        "
        
    - name: Download artifact for production
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: ./docker-images/
        
    - name: Upload artifact for production
      uses: actions/upload-artifact@v4
      with:
        name: docker-image-production
        path: ./docker-images/*.tar
        retention-days: 7
        
    - name: Verify staging deployment
      run: |
        ssh stage1@192.168.1.59 "
          echo '=== Docker containers ==='
          docker ps | grep bike-shop-container
          
          echo '=== Staging app ready for production review at http://192.168.1.59:8080 ==='
          curl -I http://localhost:8080 || echo 'Application not accessible yet'
        "
        
    - name: Verify deployment
      run: |
        ssh app@192.168.1.47 "
          echo '=== Docker containers ==='
          docker ps | grep bike-shop-container
          
          echo '=== Nginx status ==='
          sudo systemctl status nginx --no-pager
          
          echo '=== Test application ==='
          curl -I http://localhost:80
          curl -I http://localhost:8080
        "